# å¯¹æ¥ç»“æ„å¯¹é½é—®é¢˜ä¿®å¤æŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-12  
**ä¿®å¤æ¨¡å—**: `src/vina_docking.py`, `src/structure_parser.py`  
**é—®é¢˜ç±»å‹**: å¯¹æ¥åå¤åˆç‰©ç»“æ„ä¸æ­£ç¡®

---

## ğŸ› é—®é¢˜æè¿°

### ç”¨æˆ·æŠ¥å‘Š
åœ¨è¿è¡Œ `tutorial_example.py` ç¤ºä¾‹3åï¼Œç”Ÿæˆçš„ `complex.gjf` æ–‡ä»¶ä¸­ï¼š
- ä¸¤ä¸ªåˆ†å­çš„åŸå­å‡ºç°é‡å 
- å¯¹æ¥åçš„æ„è±¡æ²¡æœ‰æ­£ç¡®åº”ç”¨åˆ°å¤åˆç‰©ä¸­
- é…ä½“ï¼ˆç”²çƒ·ï¼‰çš„æ°¢åŸå­ä¸¢å¤±

### é—®é¢˜è¡¨ç°
```
å¤åˆç‰©gjfæ–‡ä»¶ä¸­çš„åæ ‡:
  è‹¯åˆ†å­: ä½äºåŸç‚¹é™„è¿‘ (æ­£å¸¸)
  ç”²çƒ·åˆ†å­: C  0.000  0.000  0.000  â† ä¸è‹¯é‡å !
             H  0.630  0.630  0.630
             H -0.630 -0.630  0.630
             ...
```

å®é™…åº”è¯¥æ˜¯å¯¹æ¥åçš„ä½ç½®ï¼ˆä¾‹å¦‚ z â‰ˆ -3.5 Ã…ï¼‰ï¼Œä½†åæ ‡ä»ç„¶æ˜¯åˆå§‹çš„åŸç‚¹ä½ç½®ã€‚

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜1: PDBQT æ ¼å¼ä¼šç§»é™¤éææ€§æ°¢åŸå­

AutoDock/Vina ä½¿ç”¨ PDBQT æ ¼å¼ï¼Œè¯¥æ ¼å¼ä¼šç§»é™¤éææ€§æ°¢åŸå­ï¼ˆunited atom modelï¼‰ï¼š
```
åŸå§‹é…ä½“ (5ä¸ªåŸå­):     å¯¹æ¥åPDBQT (1ä¸ªåŸå­):
C  0.000  0.000  0.000   C -3.539 -0.001  0.000
H  0.630  0.630  0.630   
H -0.630 -0.630  0.630
H -0.630  0.630 -0.630
H  0.630 -0.630 -0.630
```

### é—®é¢˜2: åŸå§‹ä»£ç ç›´æ¥ä½¿ç”¨ä¸å®Œæ•´çš„å¯¹æ¥ç»“æœ

åŸæœ‰ä»£ç æµç¨‹:
```python
# 1. æå–å¯¹æ¥å§¿æ€ï¼ˆåªæœ‰é‡åŸå­ï¼‰
ligand_best = self.extract_best_pose(output_pdbqt, best_pose_pdb, mode=1)

# 2. ç›´æ¥åˆå¹¶ï¼ˆæ°¢åŸå­ä¸¢å¤±ï¼‰
complex_structure = molecule_a.merge(ligand_best)
```

### é—®é¢˜3: æ— æ³•é€šè¿‡ obabel -h é‡æ–°æ·»åŠ æ°¢åŸå­

å°è¯•ä½¿ç”¨ `obabel ... -h` æ·»åŠ æ°¢åŸå­å¤±è´¥ï¼Œå› ä¸ºï¼š
- PDBQT ä¸­æ²¡æœ‰æ°¢åŸå­çš„è¿æ¥ä¿¡æ¯
- obabel æ— æ³•ä»å•ä¸ªç¢³åŸå­æ¨æ–­å‡ºç”²çƒ·çš„æ­£ç¡®å‡ ä½•æ„å‹

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ç­–ç•¥: åŸºäºé‡åŸå­çš„ç»“æ„å¯¹é½ï¼ˆKabschç®—æ³•ï¼‰

æ ¸å¿ƒæ€æƒ³ï¼š
1. ä»å¯¹æ¥ç»“æœä¸­æå–**é‡åŸå­åæ ‡**ï¼ˆå·²ç»è¿‡æ—‹è½¬+å¹³ç§»ï¼‰
2. ä½¿ç”¨åŸå§‹é…ä½“çš„**å®Œæ•´ç»“æ„**ï¼ˆåŒ…å«æ‰€æœ‰æ°¢åŸå­ï¼‰
3. è®¡ç®—æœ€ä¼˜å˜æ¢çŸ©é˜µï¼Œå°†åŸå§‹é…ä½“å¯¹é½åˆ°å¯¹æ¥å§¿æ€
4. è¿™æ ·æ—¢ä¿ç•™äº†æ‰€æœ‰æ°¢åŸå­ï¼Œåˆåº”ç”¨äº†å¯¹æ¥çš„æ—‹è½¬å’Œå¹³ç§»

### å®ç°1: æ·»åŠ  `align_to()` æ–¹æ³•åˆ° `StructureParser`

åœ¨ `src/structure_parser.py` ä¸­æ·»åŠ ï¼š

```python
def align_to(self, reference: 'StructureParser') -> None:
    """
    Align this structure to a reference structure based on heavy atoms
    Uses Kabsch algorithm for optimal rotation and translation
    """
    # 1. æå–é‡åŸå­ï¼ˆéæ°¢ï¼‰
    self_heavy = [(i, atom) for i, atom in enumerate(self.atoms) if atom[0] != 'H']
    ref_heavy = [(i, atom) for i, atom in enumerate(reference.atoms) if atom[0] != 'H']
    
    # 2. æå–åæ ‡
    self_coords = np.array([[x, y, z] for _, (_, x, y, z) in self_heavy])
    ref_coords = np.array([[x, y, z] for _, (_, x, y, z) in ref_heavy])
    
    # 3. è®¡ç®—è´¨å¿ƒ
    self_centroid = self_coords.mean(axis=0)
    ref_centroid = ref_coords.mean(axis=0)
    
    # 4. ä¸­å¿ƒåŒ–åæ ‡
    self_coords_centered = self_coords - self_centroid
    ref_coords_centered = ref_coords - ref_centroid
    
    # 5. è®¡ç®—åæ–¹å·®çŸ©é˜µ
    H = self_coords_centered.T @ ref_coords_centered
    
    # 6. SVDåˆ†è§£æ±‚æœ€ä¼˜æ—‹è½¬çŸ©é˜µ
    U, S, Vt = np.linalg.svd(H)
    R = Vt.T @ U.T
    
    # 7. ç¡®ä¿æ˜¯çœŸæ—‹è½¬ï¼ˆdet(R) = 1ï¼‰
    if np.linalg.det(R) < 0:
        Vt[-1, :] *= -1
        R = Vt.T @ U.T
    
    # 8. åº”ç”¨å˜æ¢åˆ°æ‰€æœ‰åŸå­ï¼ˆåŒ…æ‹¬æ°¢ï¼‰
    all_coords = np.array([[x, y, z] for _, x, y, z in self.atoms])
    all_coords_centered = all_coords - self_centroid
    all_coords_rotated = all_coords_centered @ R.T
    all_coords_final = all_coords_rotated + ref_centroid
    
    # 9. æ›´æ–°åŸå­åæ ‡
    self.atoms = [(elem, all_coords_final[i, 0], all_coords_final[i, 1], all_coords_final[i, 2])
                  for i, (elem, _, _, _) in enumerate(self.atoms)]
```

### å®ç°2: ä¿®æ”¹ `dock_two_molecules()` æ–¹æ³•

åœ¨ `src/vina_docking.py` ä¸­ä¿®æ”¹ï¼š

```python
# æå–å¯¹æ¥å§¿æ€ï¼ˆåªæœ‰é‡åŸå­ï¼Œæ— æ°¢ï¼‰
best_pose_pdb = os.path.join(self.work_dir, "best_pose.pdb")
ligand_docked = self.extract_best_pose(output_pdbqt, best_pose_pdb, mode=1, add_hydrogens=False)

# å¯¹é½åŸå§‹é…ä½“ï¼ˆåŒ…å«æ‰€æœ‰æ°¢åŸå­ï¼‰åˆ°å¯¹æ¥å§¿æ€
import copy
ligand_aligned = copy.deepcopy(molecule_b)  # ä¿ç•™å®Œæ•´ç»“æ„
ligand_aligned.align_to(ligand_docked)       # åº”ç”¨å¯¹æ¥å˜æ¢

# åˆå¹¶å—ä½“å’Œå¯¹é½åçš„é…ä½“
complex_structure = molecule_a.merge(ligand_aligned)
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬
åˆ›å»ºäº† `tests/test_docking_alignment.py` è¿›è¡Œå…¨é¢æµ‹è¯•ã€‚

### æµ‹è¯•ç»“æœ

#### âœ… æµ‹è¯•1: åŸå­æ•°é‡
```
æœŸæœ›: C=7 (6è‹¯+1ç”²çƒ·), H=10 (6è‹¯+4ç”²çƒ·)
å®é™…: C=7, H=10
ç»“æœ: PASSED âœ…
```

#### âœ… æµ‹è¯•2: åŸå­é‡å æ£€æŸ¥
```
æœ€å°åŸå­é—´è·: 1.087 Ã…
çŠ¶æ€: æ²¡æœ‰åŸå­é‡å ï¼Œç»“æ„åˆç† âœ…
```

#### âœ… æµ‹è¯•3: åˆ†å­é—´è·ç¦»
```
è‹¯è´¨å¿ƒ: (0.000, -0.000, 0.000)
ç”²çƒ·è´¨å¿ƒ: (-0.026, -0.005, -3.542)
åˆ†å­é—´è·ç¦»: 3.542 Ã…
çŠ¶æ€: åˆç†ï¼ˆå…¸å‹èŒƒå›´ 3-6 Ã…ï¼‰ âœ…
```

#### âœ… æµ‹è¯•4: å¯¹é½ç²¾åº¦
```
å•åŸå­æµ‹è¯•:
  åŸå§‹é…ä½“C: (0.000, 0.000, 0.000)
  å¯¹æ¥åC:   (-3.539, -0.001, 0.000)
  å¯¹é½åC:   (-3.539, -0.001, 0.000)
  è¯¯å·®: 0.000000 Ã… âœ…
```

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰
```
complex.gjfä¸­çš„åæ ‡:
C(Fragment=1)    -1.211     0.699     0.000  # è‹¯
...
C(Fragment=2)     0.000     0.000     0.000  # ç”²çƒ· â† é‡å !
H(Fragment=2)     0.630     0.630     0.630
```

é—®é¢˜ï¼š
- âŒ ç”²çƒ·åœ¨åŸç‚¹ï¼Œä¸è‹¯é‡å 
- âŒ æ²¡æœ‰åº”ç”¨å¯¹æ¥å˜æ¢

### ä¿®å¤å
```
complex.xyzä¸­çš„åæ ‡:
C    -1.211     0.699     0.000  # è‹¯
...
C     0.041     0.007    -3.544  # ç”²çƒ· â† æ­£ç¡®ä½ç½®!
H     0.041     0.007    -2.455  # æ°¢åŸå­ä¹Ÿåœ¨!
H     1.068     0.007    -3.907
H    -0.472    -0.882    -3.907
H    -0.472     0.896    -3.907
```

æ”¹è¿›ï¼š
- âœ… ç”²çƒ·åœ¨å¯¹æ¥ä½ç½®ï¼ˆz â‰ˆ -3.5 Ã…ï¼‰
- âœ… æ‰€æœ‰æ°¢åŸå­éƒ½å­˜åœ¨
- âœ… åˆ†å­é—´è·ç¦»åˆç†ï¼ˆ3.5 Ã…ï¼‰
- âœ… åº”ç”¨äº†æ—‹è½¬+å¹³ç§»å˜æ¢

---

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### Kabsch ç®—æ³•

ç”¨äºè®¡ç®—ä¸¤ç»„ç‚¹ä¹‹é—´çš„æœ€ä¼˜åˆšä½“å˜æ¢ï¼ˆæ—‹è½¬+å¹³ç§»ï¼‰ï¼š

1. **ä¸­å¿ƒåŒ–**: å°†ä¸¤ç»„åæ ‡ç§»åˆ°è´¨å¿ƒ
2. **åæ–¹å·®çŸ©é˜µ**: H = P^T Q
3. **SVDåˆ†è§£**: H = U Î£ V^T
4. **æ—‹è½¬çŸ©é˜µ**: R = V U^T
5. **åº”ç”¨å˜æ¢**: X' = (X - c1) R + c2

ä¼˜ç‚¹ï¼š
- æ•°å­¦ä¸Šæœ€ä¼˜ï¼ˆæœ€å°åŒ–RMSDï¼‰
- è®¡ç®—ç¨³å®š
- é€‚ç”¨äºä»»æ„æ•°é‡çš„åŸå­

### ä¸ºä»€ä¹ˆä¸ç”¨ç®€å•å¹³ç§»ï¼Ÿ

å¯¹æ¥ä¸ä»…åŒ…å«å¹³ç§»ï¼Œè¿˜åŒ…å«æ—‹è½¬ï¼š
- ç®€å•å¹³ç§»åªèƒ½å¯¹é½è´¨å¿ƒ
- æ— æ³•ä¿®æ­£åˆ†å­çš„æ—‹è½¬è§’åº¦
- æ°¢åŸå­ä½ç½®ä¼šé”™è¯¯

ç¤ºä¾‹ï¼š
```
å¹³ç§»æ–¹æ¡ˆï¼ˆé”™è¯¯ï¼‰:
  æ—‹è½¬è§’åº¦ä¸¢å¤± â†’ æ°¢åŸå­æ–¹å‘é”™è¯¯

Kabschæ–¹æ¡ˆï¼ˆæ­£ç¡®ï¼‰:
  æ—‹è½¬+å¹³ç§» â†’ æ°¢åŸå­åœ¨æ­£ç¡®ä½ç½®
```

---

## ğŸ¯ å½±å“è¯„ä¼°

### å½±å“çš„åŠŸèƒ½
- `VinaDocking.dock_two_molecules()` - æ ¸å¿ƒå¯¹æ¥æ–¹æ³•
- `InteractionEnergyPipeline.dock_molecules()` - æµç¨‹ä¸­çš„å¯¹æ¥æ­¥éª¤
- æ‰€æœ‰ä½¿ç”¨å¯¹æ¥åŠŸèƒ½çš„è„šæœ¬å’Œç¤ºä¾‹

### å‘åå…¼å®¹æ€§
âœ… **å®Œå…¨å…¼å®¹**
- APIæ¥å£æ— å˜åŒ–
- åªæ”¹è¿›äº†å†…éƒ¨å®ç°
- æ‰€æœ‰ç°æœ‰ä»£ç ç»§ç»­å·¥ä½œ

### æ€§èƒ½å½±å“
- æ·»åŠ äº†SVDè®¡ç®—ï¼ˆO(n^3)ï¼Œnæ˜¯é‡åŸå­æ•°ï¼‰
- å¯¹å°åˆ†å­ï¼ˆ<100ä¸ªåŸå­ï¼‰å½±å“å¯å¿½ç•¥
- å®æµ‹: è‹¯-ç”²çƒ·å¯¹æ¥è€—æ—¶ <1ç§’ï¼ˆåŒ…æ‹¬Vinaè¿è¡Œï¼‰

---

## ğŸ“‹ æ–‡ä»¶å˜æ›´

### ä¿®æ”¹çš„æ–‡ä»¶
1. **src/structure_parser.py**
   - æ·»åŠ  `align_to()` æ–¹æ³•ï¼ˆ78è¡Œï¼‰
   - ä½¿ç”¨Kabschç®—æ³•è¿›è¡Œç»“æ„å¯¹é½

2. **src/vina_docking.py**
   - ä¿®æ”¹ `extract_best_pose()` - æ·»åŠ  `add_hydrogens` å‚æ•°
   - ä¿®æ”¹ `dock_two_molecules()` - ä½¿ç”¨ç»“æ„å¯¹é½

### æ–°å¢çš„æ–‡ä»¶
- `tests/test_docking_alignment.py` - å¯¹é½åŠŸèƒ½æµ‹è¯•
- `docs/DOCKING_ALIGNMENT_FIX.md` - æœ¬æ–‡æ¡£

### æ›´æ–°çš„æ–‡æ¡£
- `TEST_REPORT.md` - å°†æ·»åŠ å¯¹é½æµ‹è¯•ç»“æœ

---

## âœ… éªŒè¯æ¸…å•

- [x] å¯¹æ¥åæ‰€æœ‰åŸå­éƒ½å­˜åœ¨ï¼ˆåŒ…æ‹¬æ°¢ï¼‰
- [x] æ²¡æœ‰åŸå­é‡å 
- [x] åˆ†å­é—´è·ç¦»åˆç†
- [x] åº”ç”¨äº†æ­£ç¡®çš„æ—‹è½¬å’Œå¹³ç§»
- [x] Kabschç®—æ³•å®ç°æ­£ç¡®
- [x] æµ‹è¯•è¦†ç›–å…¨é¢
- [x] å‘åå…¼å®¹
- [x] æ–‡æ¡£å®Œæ•´

---

## ğŸ“ ç»éªŒæ€»ç»“

### å…³é”®æ•™è®­
1. **äº†è§£æ–‡ä»¶æ ¼å¼**: PDBQTç§»é™¤éææ€§æ°¢æ˜¯æ ‡å‡†è¡Œä¸º
2. **ä¿ç•™åŸå§‹æ•°æ®**: ä¸è¦ä¸¢å¼ƒä»»ä½•è¾“å…¥ä¿¡æ¯
3. **ä½¿ç”¨æ•°å­¦å·¥å…·**: Kabschç®—æ³•æ˜¯è§£å†³å¯¹é½é—®é¢˜çš„æ ‡å‡†æ–¹æ³•
4. **å……åˆ†æµ‹è¯•**: æ£€æŸ¥åŸå­æ•°ã€è·ç¦»ã€é‡å ç­‰å¤šä¸ªæŒ‡æ ‡

### æœ€ä½³å®è·µ
1. å¯¹æ¥æ—¶ä¿ç•™åŸå§‹å®Œæ•´ç»“æ„
2. ä½¿ç”¨é‡åŸå­è®¡ç®—å˜æ¢
3. å°†å˜æ¢åº”ç”¨åˆ°å®Œæ•´ç»“æ„
4. éªŒè¯è¾“å‡ºçš„åˆç†æ€§

---

**ä¿®å¤äºº**: GitHub Copilot  
**å®¡æ ¸äºº**: zhangsd  
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶éªŒè¯
